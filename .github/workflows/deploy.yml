# .github/workflows/deploy.yml

name: Deploy to Contabo

# Dispara o workflow em cada push para a branch 'main'
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üìÇ Sync files to server
        # Copia os ficheiros do reposit√≥rio para o servidor, excluindo node_modules e .git
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CONTABO_HOST }}
          username: ${{ secrets.CONTABO_USER }}
          key: ${{ secrets.CONTABO_SSH_KEY }}
          source: "."
          target: "/home/${{ secrets.CONTABO_USER }}/cambioao" # Ajuste se o caminho for diferente
          strip_components: 1 # Remove o primeiro n√≠vel de diret√≥rio da origem
          rm: true # Remove ficheiros no destino que n√£o existem na origem

      - name: üöÄ Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CONTABO_HOST }}
          username: ${{ secrets.CONTABO_USER }}
          key: ${{ secrets.CONTABO_SSH_KEY }}
          script: |
            # Navega para a pasta do projeto
            cd /home/${{ secrets.CONTABO_USER }}/cambioao

            # Cria o ficheiro .env no servidor com as chaves secretas do GitHub
            echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
            echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env
            echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}" >> .env

            # Faz o build da nova imagem e reinicia o servi√ßo com docker-compose
            # O --build for√ßa a reconstru√ß√£o da imagem com o novo c√≥digo
            # O -d (detached) executa em segundo plano
            sudo docker-compose -f docker-compose.prod.yml up --build -d

            # Limpa imagens Docker antigas e n√£o utilizadas para poupar espa√ßo
            sudo docker image prune -af
