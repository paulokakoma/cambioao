<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />    
    <title>C√¢mbio Angola Hoje - Taxas D√≥lar Kwanza, Euro Kwanza | cambioao</title>
    <meta name="description" content="Consulte as taxas de c√¢mbio do d√≥lar, euro e outras divisas em Angola. Compare o mercado formal (bancos) e informal (kinguilas) em tempo real. Calculadora de custos de importa√ß√£o.">
    <meta name="keywords" content="cambio angola, dolar kwanza, euro kwanza, cambioao, divisas angola, taxas de cambio, mercado informal, kinguilas, pre√ßo do dolar hoje angola">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="stylesheet" href="/css/output.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root { --theme-color: #19b57f; }
      body { font-family: "Inter", sans-serif; background-color: #f3f4f6; color: #1f2937; min-height: 100vh; }
      .market-container { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 28px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05); }
      /* Carousel arrows */
      .carousel-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 30;
        background: rgba(15, 23, 42, 0.6);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      @media (min-width: 768px) {
        .carousel-arrow {
          width: 40px;
          height: 40px;
          border-radius: 8px;
        }
      }
      .carousel-arrow:hover { background: rgba(15, 23, 42, 0.8); }
      
      /* Dimens√µes responsivas dos banners baseadas em 1500x530 */
      .banner-container {
        /* Propor√ß√£o 1500:530 ‚âà 2.83:1 */
        aspect-ratio: 1500 / 530;
        max-width: 1500px;
        width: 100%;
      }
      
      /* Alturas espec√≠ficas para diferentes breakpoints */
      @media (max-width: 640px) {
        .banner-container {
          height: 85px; /* ~150px de largura */
        }
      }
      
      @media (min-width: 641px) and (max-width: 768px) {
        .banner-container {
          height: 110px; /* ~315px de largura */
        }
      }
      
      @media (min-width: 769px) and (max-width: 1024px) {
        .banner-container {
          height: 135px; /* ~387px de largura */
        }
      }
      
      @media (min-width: 1025px) and (max-width: 1280px) {
        .banner-container {
          height: 182px; /* ~522px de largura */
        }
      }
      
      @media (min-width: 1281px) {
        .banner-container {
          height: 250px; /* ~717px de largura */
        }
      }
      
      @media (min-width: 1500px) {
        .banner-container {
          height: 350px; /* ~1004px de largura */
        }
      }
      
      @media (min-width: 1800px) {
        .banner-container {
          height: 400px; /* ~1148px de largura */
        }
      }
      
      @media (min-width: 2000px) {
        .banner-container {
          height: 530px; /* 1500px de largura - dimens√£o original */
        }
      }
      
      .calculator-card { box-shadow: 0 32px 64px rgba(0, 0, 0, 0.3); transition: all 0.5s ease-in-out; border-radius: 24px; }
      .theme-bai { background-image: linear-gradient(to bottom, #0194b3, #006c6e, #b56b3e); }
      .theme-bfa { background-image: radial-gradient(circle, #f7931e, #eb5c28); }
      .theme-bic { background-image: linear-gradient(to right, #d42128, #2b2b2b); }
      .theme-bpc { background-image: linear-gradient(to right, #00529b, #00417a); }
      .theme-bci { background-color: #1f3a38; }
      .theme-yetu { background-image: linear-gradient(135deg, #00401A, #EAA900); }
      .theme-default { background-image: linear-gradient(to right, #3b82f6, #2563eb); }
      .border-theme-bai { border-color: #0194b3; } .text-theme-bai { color: #0194b3; }
      .border-theme-bfa { border-color: #f7931e; } .text-theme-bfa { color: #f7931e; }
      .border-theme-bic { border-color: #d42128; } .text-theme-bic { color: #d42128; }
      .border-theme-bpc { border-color: #00529b; } .text-theme-bpc { color: #00529b; }
      .border-theme-bci { border-color: #1f3a38; } .text-theme-bci { color: #1f3a38; }
      .border-theme-yetu { border-color: #EAA900; } .text-theme-yetu { color: #EAA900; }
      .border-theme-default { border-color: #3b82f6; } .text-theme-default { color: #3b82f6; }
      .border-theme-bna { border-color: #64748b; } .text-theme-bna { color: #64748b; }
      .bg-theme-bai-faded { background-color: rgba(1, 148, 179, 0.07); }
      .bg-theme-bfa-faded { background-color: rgba(247, 147, 30, 0.07); }
      .bg-theme-bic-faded { background-color: rgba(212, 33, 40, 0.07); }
      .bg-theme-bpc-faded { background-color: rgba(0, 82, 155, 0.07); }
      .bg-theme-bci-faded { background-color: rgba(31, 58, 56, 0.07); }
      .bg-theme-yetu-faded { background-color: rgba(234, 169, 0, 0.07); }
      .bg-theme-default-faded { background-color: rgba(59, 130, 246, 0.07); }
      .bg-theme-bna-faded { background-color: rgba(100, 116, 139, 0.07); }
      .market-header { color: var(--theme-color); transition: color 0.5s ease; }
      .tab-button { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 700; font-size: 1.25rem; }
      .tab-active { background-color: var(--theme-color); color: white; transform: scale(1.03); box-shadow: 0 12px 30px rgba(25, 181, 127, 0.2); }
      .tab-inactive { background-color: #e5e7eb; color: #4b5563; }
      .tab-inactive:hover { background-color: #d1d5db; }
      .calc-input { font-family: 'JetBrains Mono', monospace; }
      .province-tab { border-bottom: 3px solid transparent; transition: all 0.3s ease; }
      .province-tab-active { border-color: var(--theme-color); color: var(--theme-color); }
      @keyframes spin { to { transform: rotate(360deg); } }
      @keyframes pulse {
        50% { opacity: .6; }
      }
      .skeleton {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        background-color: #e5e7eb; /* gray-200 */
        border-radius: 0.5rem; /* rounded-lg */
      }
      .skeleton-dark {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        background-color: #4b5563; /* gray-600 */
        border-radius: 0.5rem; /* rounded-lg */
      }
      .custom-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
      .loader { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: var(--theme-color); border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; transition: color 0.5s ease; }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      @keyframes scroll-left {
      }
      .animate-scroll {
        /* Anima√ß√£o infinita - move 33.33% (1/3) da dist√¢ncia total j√° que temos 3 c√≥pias */
        animation: scroll 40s linear infinite;
      }
      
      /* Otimiza√ß√£o de performance para anima√ß√£o suave */
      .scrolling-content {
        will-change: transform;
        transform: translateZ(0);
      }
            /* Carousel arrows and helpers */
            .carousel-arrow {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                z-index: 30;
                background: rgba(15, 23, 42, 0.6);
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 8px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
            }
            .carousel-arrow:hover { background: rgba(15,23,42,0.8); }
            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
  </head>
  <body class="min-h-screen">
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-emerald-600">cambioao</a>
            <nav class="flex items-center space-x-4 md:space-x-8">
                <a href="/" class="text-sm md:text-base font-semibold text-emerald-600 hover:text-emerald-700 transition-colors">Mercado</a>
                <a href="/sobre" class="text-sm md:text-base font-semibold text-slate-600 hover:text-emerald-600 transition-colors">Sobre N√≥s</a>
            </nav>
        </div>
    </header>
    <main class="w-full max-w-7xl mx-auto mt-12 px-6 pb-12">
      <div class="mb-12">
        <div class="grid grid-cols-2 gap-4 rounded-3xl bg-white shadow-md p-3" role="tablist">
          <button class="tab-button tab-active rounded-2xl py-4 px-8 text-lg font-bold focus:outline-none" id="market-tab" type="button" role="tab">üè¶ Mercado</button>
          <button class="tab-button tab-inactive rounded-2xl py-4 px-8 text-lg font-bold focus:outline-none" id="calculator-tab" type="button" role="tab">üßÆ Calculadora</button>
        </div>
      </div>
      <section id="myTabContent">
        <div id="market-panel" role="tabpanel">
            <div class="mb-8 flex justify-center">
                <div class="flex space-x-2 bg-gray-200 p-2 rounded-full" role="tablist">
                    <button id="formal-market-tab-btn" role="tab" class="py-2 px-8 rounded-full font-semibold transition-all duration-300">Formal</button>
                    <button id="informal-market-tab-btn" role="tab" class="py-2 px-8 rounded-full font-semibold transition-all duration-300">Informal</button>
                </div>
            </div>
             <div id="formal-market-panel" role="tabpanel">
                 <div class="market-container p-6 md:p-8">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center mb-6">üèõÔ∏è MERCADO FORMAL (Taxas Banc√°rias)</h3>
                    
                    <!-- Novo Conversor de Moeda -->
                    <div id="quick-converter-container" class="mb-8 p-6 bg-slate-50 rounded-2xl border border-slate-200">
                        <h4 class="text-lg font-bold text-gray-700 mb-4">Conversor R√°pido (<span id="quick-converter-bank-name">--</span>)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <!-- Campo de Valor -->
                            <div class="md:col-span-2">
                                <label for="quick-converter-amount" class="block text-sm font-medium text-gray-600">Valor a converter</label>
                                <input type="text" id="quick-converter-amount" inputmode="decimal" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-lg font-mono" placeholder="100,00">
                            </div>
                    
                            <!-- Seletores de Moeda e Alternador -->
                            <div class="md:col-span-3 flex items-end gap-2">
                                <div class="flex-1">
                                    <label for="quick-converter-from" class="block text-sm font-medium text-gray-600">De</label>
                                    <select id="quick-converter-from" class="custom-select mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg font-semibold">
                                        <option value="USD">üá∫üá∏ USD</option>
                                        <option value="EUR">üá™üá∫ EUR</option>
                                        <option value="AOA">üá¶üá¥ AOA</option>
                                    </select>
                                </div>
                                <button id="quick-converter-switch" class="p-3 mb-0.5 bg-gray-200 hover:bg-gray-300 rounded-full transition-transform duration-300 focus:outline-none"><svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg></button>
                                <div class="flex-1">
                                    <label for="quick-converter-to" class="block text-sm font-medium text-gray-600">Para</label>
                                    <select id="quick-converter-to" class="custom-select mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg font-semibold">
                                        <option value="AOA">üá¶üá¥ AOA</option>
                                        <option value="USD">üá∫üá∏ USD</option>
                                        <option value="EUR">üá™üá∫ EUR</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="quick-converter-result" class="mt-4 text-center text-2xl font-bold text-gray-800 h-8"></div>
                    </div>

                    <div id="formal-market-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 min-h-[200px]">
                        <!-- Skeleton para Mercado Formal -->
                        ${Array(3).fill(0).map(() => `
                        <div class="p-4 rounded-xl border-l-4 border-gray-200 bg-gray-50 shadow-sm h-full">
                            <div class="skeleton h-6 w-1/4 mb-2"></div>
                            <div class="skeleton h-4 w-1/2 mb-6"></div>
                            <div class="space-y-4 mt-4">
                                <div>
                                    <div class="flex justify-between items-baseline">
                                        <div class="skeleton h-5 w-1/3"></div>
                                        <div class="skeleton h-6 w-1/4"></div>
                                    </div>
                                    <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                                </div>
                                <div class="pt-3 border-t border-gray-200">
                                    <div class="flex justify-between items-baseline">
                                        <div class="skeleton h-5 w-1/3"></div>
                                        <div class="skeleton h-6 w-1/4"></div>
                                    </div>
                                    <div class="skeleton h-4 w-1/3 ml-auto mt-1"></div>
                                </div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>
             </div>
             <div id="informal-market-panel" role="tabpanel" class="hidden">
                 <div class="market-container p-6 md:p-8">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6">
                       <h3 class="text-2xl font-bold text-gray-800 flex items-center mb-4 md:mb-0">üè™ MERCADO INFORMAL</h3>
                       <div id="province-tabs" class="flex space-x-4 border-b md:border-b-0 border-gray-200 overflow-x-auto" role="tablist">
                       </div>
                    </div>
                    <div id="informal-market-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 min-h-[150px]">
                        <!-- Skeleton para Mercado Informal -->
                        ${Array(4).fill(0).map(() => `
                        <div class="bg-gray-50 border border-gray-200 p-4 rounded-xl">
                            <div class="skeleton h-5 w-3/4 mb-2"></div>
                            <div class="skeleton h-8 w-1/2 mb-4"></div>
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="skeleton h-4 w-full"></div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>
        </div>
        <div id="calculator-panel" class="hidden" role="tabpanel">
          <div id="calculator-card-container" class="w-full max-w-xl mx-auto calculator-card min-h-[400px]">
            <!-- Skeleton para Calculadora -->
            <div class="p-8">
                <div class="text-center mb-8">
                    <div class="skeleton-dark h-9 w-3/4 mx-auto mb-3"></div>
                    <div class="skeleton-dark h-5 w-1/2 mx-auto"></div>
                </div>
                <div class="skeleton-dark h-6 w-1/3 mb-3"></div>
                <div class="skeleton-dark h-16 w-full mb-6"></div>
                <div class="skeleton-dark h-16 w-full"></div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!-- Sec√ß√£o de Apoiadores -->
    <section id="supporters-section" class="w-full bg-slate-50 py-16 mt-12 hidden">
        <div class="w-full max-w-7xl mx-auto">
            <h2 class="text-4xl font-bold text-slate-800 text-center mb-12">Nossos Apoiadores</h2>
        </div>
        <div id="supporters-container-wrapper" class="relative w-full group">
            <!-- Bot√µes de navega√ß√£o -->
            <button id="supporter-prev" class="absolute left-4 top-1/2 -translate-y-1/2 z-20 bg-white/80 backdrop-blur-sm hover:bg-white/90 p-3 rounded-full shadow-lg transition-all duration-300 opacity-0 group-hover:opacity-100 disabled:opacity-0">
                <svg class="w-6 h-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button id="supporter-next" class="absolute right-4 top-1/2 -translate-y-1/2 z-20 bg-white/80 backdrop-blur-sm hover:bg-white/90 p-3 rounded-full shadow-lg transition-all duration-300 opacity-0 group-hover:opacity-100 disabled:opacity-0">
                <svg class="w-6 h-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
            
            <!-- Container para Apoiadores -->
            <div id="supporters-carousel-container" class="relative overflow-hidden">
                <div class="flex items-center justify-center w-full">
                    <div class="relative w-full banner-container rounded-2xl">
                        <div id="supporter-slides-wrapper" class="flex h-full transition-transform duration-700 ease-in-out">
                            <!-- Skeleton Loader -->
                            <div class="supporter-slide flex-shrink-0 w-full h-full flex items-center justify-center"><div class="skeleton h-full w-full animate-pulse"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Indicadores de slide -->
            <div id="supporter-indicators" class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 flex justify-center items-center gap-2 z-10">
            </div>
        </div>
    </section>

    <div class="bg-slate-800 text-slate-300">
        <!-- Sec√ß√£o de Afiliados movida para dentro de um div -->
        <div class="w-full max-w-7xl mx-auto px-6 py-16">
            <h2 class="text-3xl font-bold text-white text-center mb-12">Ofertas dos Nossos Parceiros</h2> 
            <div id="affiliate-links-wrapper" class="relative group">
                <!-- Bot√£o de Recuar -->
                <button id="affiliate-prev-btn" class="carousel-arrow left-0 md:-left-5 opacity-0 group-hover:opacity-100 transition-opacity">
                    &#x2190;
                </button>

                <!-- Container com scroll -->
                <div id="affiliate-links-container" class="flex overflow-x-auto no-scrollbar -mx-4 px-4">
                    <!-- Conte√∫do din√¢mico -->
                    <div id="affiliate-track" class="flex flex-shrink-0 gap-x-8 py-4">
                        <!-- Skeleton Loader -->
                        <div class="flex gap-x-4 px-4">
                            ${Array(4).fill(0).map(() => `
                                <div class="block bg-slate-700 rounded-lg overflow-hidden shadow-lg w-48 md:w-56 flex-shrink-0">
                                    <div class="skeleton-dark h-32 w-full"></div>
                                    <div class="p-3">
                                        <div class="skeleton-dark h-5 w-full mb-2"></div>
                                        <div class="skeleton-dark h-6 w-3/4"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Bot√£o de Avan√ßar -->
                <button id="affiliate-next-btn" class="carousel-arrow right-0 md:-right-5 opacity-0 group-hover:opacity-100 transition-opacity">
                    &#x2192;
                </button>
            </div>

            <p class="text-xs text-slate-500 text-center mt-12">Ao clicar nestes links e fazer uma compra, poderemos receber uma comiss√£o sem custo adicional para si.</p>
        </div>
    </div>

    <footer class="bg-slate-900 text-slate-400 py-8">
        <div class="max-w-7xl mx-auto px-6 text-center text-sm">
            <div id="footer-contact-info" class="mb-4 space-y-2">
                <!-- As informa√ß√µes de contato ser√£o carregadas aqui -->
            </div>
            <div class="mt-6">
                <h4 class="text-slate-300 font-semibold mb-3">Siga-nos</h4>
                <div id="social-media-links" class="flex justify-center space-x-4">
                    <!-- Social media links will be loaded here -->
                </div>
            </div>
            <p class="mt-6">&copy; 2024 cambioao. Todos os direitos reservados.</p>
        </div>
    </footer>
    
    <script type="module">
        // --- CONFIGURA√á√ÉO ---
        const WEBSOCKET_URL = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}`;

        let SESSION_ID;
        let dbClient;
        let ws;
        let marketData; // Declarada no escopo do m√≥dulo
        let affiliateAutoScrollInterval; // Vari√°vel para controlar o auto-scroll

        const appState = {
            selectedBank: { code: 'BNA', usd_rate: 0, eur_rate: 0 },
            _listeners: [], addListener(fn) { this._listeners.push(fn); },
            updateSelectedBank(bankData) { this.selectedBank = bankData; this._listeners.forEach(fn => fn(bankData)); }
        };

        const currencyFlags = { USD: 'üá∫üá∏', EUR: 'üá™üá∫', AOA: 'üá¶üá¥', USDT: 'ü™ô' };

        // --- FUN√á√ïES DE UTILIDADE ---
        function getOrCreateSessionId() {
            let sessionId = sessionStorage.getItem('app_session_id');
            if (!sessionId) {
                sessionId = crypto.randomUUID();
                sessionStorage.setItem('app_session_id', sessionId);
            }
            return sessionId;
        }

        function formatNumber(num) {
            if (typeof num !== 'number') return 'N/A';
            return num.toLocaleString('pt-AO', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
        }

        function formatCurrency(value, currency = 'AOA') {
            if (typeof value !== 'number') return 'N/A';
            return new Intl.NumberFormat('pt-AO', { style: 'currency', currency }).format(value);
        }

        // --- FUN√á√ïES DE NAVEGA√á√ÉO ---
        function switchTab(tabName) {
            const [calculatorTab, marketTab] = [document.getElementById('calculator-tab'), document.getElementById('market-tab')];
            const [calculatorPanel, marketPanel] = [document.getElementById('calculator-panel'), document.getElementById('market-panel')];
            if (tabName === 'calculator') {
                marketPanel.classList.add('hidden'); calculatorPanel.classList.remove('hidden');
                marketTab.classList.replace('tab-active', 'tab-inactive'); calculatorTab.classList.replace('tab-inactive', 'tab-active');
                logActivity('tab_switch', { tab: 'Calculadora' });
            } else {
                calculatorPanel.classList.add('hidden'); marketPanel.classList.remove('hidden');
                calculatorTab.classList.replace('tab-active', 'tab-inactive'); marketTab.classList.replace('tab-inactive', 'tab-active');
                logActivity('tab_switch', { tab: 'Mercado' });
            }
        }

        function switchMarketTab(tabName) {
            const [formalTabBtn, informalTabBtn] = [document.getElementById('formal-market-tab-btn'), document.getElementById('informal-market-tab-btn')];
            const [formalPanel, informalPanel] = [document.getElementById('formal-market-panel'), document.getElementById('informal-market-panel')];
            const activeClasses = ['bg-white', 'text-[var(--theme-color)]', 'shadow-md'], inactiveClasses = ['text-gray-600'];
            
            formalPanel.classList.toggle('hidden', tabName !== 'formal');
            informalPanel.classList.toggle('hidden', tabName === 'formal');
            
            formalTabBtn.classList.add(...(tabName === 'formal' ? activeClasses : inactiveClasses));
            formalTabBtn.classList.remove(...(tabName !== 'formal' ? activeClasses : inactiveClasses));
            
            informalTabBtn.classList.add(...(tabName !== 'formal' ? activeClasses : inactiveClasses));
            informalTabBtn.classList.remove(...(tabName === 'formal' ? activeClasses : inactiveClasses));
        }

        function setupEventListeners() {
            document.getElementById('market-tab').addEventListener('click', () => switchTab('market'));
            document.getElementById('calculator-tab').addEventListener('click', () => switchTab('calculator'));
            document.getElementById('formal-market-tab-btn').addEventListener('click', () => switchMarketTab('formal'));
            document.getElementById('informal-market-tab-btn').addEventListener('click', () => switchMarketTab('informal'));
        }

        // --- M√ìDULO DO MERCADO ---
        const MarketModule = (function() {
            function renderBankCards(containerId, banks) {
                const gridContainer = document.getElementById(containerId);
                if (!gridContainer || !banks || banks.length === 0) {
                    if(gridContainer) gridContainer.innerHTML = '<p class="col-span-full text-center text-slate-500 py-8">Nenhum banco dispon√≠vel de momento.</p>';
                    return;
                };
                
                const bna = banks.find(b => b.code === 'BNA') || banks[0];
                if (bna) {
                    appState.updateSelectedBank({ code: bna.code, usd_rate: bna.usd_rate, eur_rate: bna.eur_rate });
                }

                const displayBanks = banks.filter(b => b.code !== 'BNA').sort((a,b) => (a.usd_rate || Infinity) - (b.usd_rate || Infinity));
                
                gridContainer.innerHTML = displayBanks.map(bank => {
                    const themeCode = CalculatorModule.getThemeCode(bank.code.toLowerCase());
                    const usd_equivalence = bank.usd_rate ? formatNumber(100 * bank.usd_rate) : 'N/A';
                    const eur_equivalence = bank.eur_rate ? formatNumber(100 * bank.eur_rate) : 'N/A';
                    return `
                        <div class="p-4 rounded-xl border-l-4 border-theme-${themeCode} bg-theme-${themeCode}-faded shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between h-full">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${bank.code}</p><p class="text-xs text-gray-500">${bank.name}</p>
                                <div class="space-y-4 mt-4">
                                    <div>
                                        <div class="flex justify-between items-baseline"><span class="text-sm font-semibold text-gray-600">${currencyFlags.USD} USD/AOA</span><span class="text-lg font-bold text-theme-${themeCode} font-mono">${formatNumber(bank.usd_rate)}</span></div>
                                        <p class="text-xs text-gray-500 text-right">100 USD ‚âà ${usd_equivalence} AOA</p>
                                    </div>
                                    <div class="pt-3 border-t border-gray-100">
                                        <div class="flex justify-between items-baseline"><span class="text-sm font-semibold text-gray-600">${currencyFlags.EUR} EUR/AOA</span><span class="text-lg font-bold text-theme-${themeCode} font-mono">${formatNumber(bank.eur_rate)}</span></div>
                                        <p class="text-xs text-gray-500 text-right">100 EUR ‚âà ${eur_equivalence} AOA</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }).join('');
            }

            function renderInformalMarket(data) { // data is informal_rates_by_province
                const tabsContainer = document.getElementById('province-tabs');
                if (!tabsContainer || !data || Object.keys(data).length === 0) {
                    document.getElementById('informal-market-grid').innerHTML = '<p class="col-span-full text-center text-slate-500 py-8">Nenhuma taxa informal dispon√≠vel de momento.</p>';
                    return;
                }
                
                const provinces = Object.keys(data);
                tabsContainer.innerHTML = provinces.map(provinceCode => `<button data-provider-id="${data[provinceCode][0]?.provider_id}" data-province="${provinceCode}" class="province-tab font-semibold pb-2 px-1">${provinceCode}</button>`).join('');

                document.querySelectorAll('.province-tab').forEach(tab => {
                     tab.addEventListener('click', () => {
                        document.querySelectorAll('.province-tab').forEach(t => t.classList.remove('province-tab-active'));
                        tab.classList.add('province-tab-active');
                        renderInformalGrid(tab.dataset.province, data);
                        loadSupporters(tab.dataset.providerId); // Carrega os apoiadores da prov√≠ncia selecionada
                    });
                });

                if(provinces.length > 0) {
                    const defaultProvince = provinces[0];
                    tabsContainer.querySelector(`[data-province="${defaultProvince}"]`).classList.add('province-tab-active');
                    renderInformalGrid(defaultProvince, data);
                    loadSupporters(tabsContainer.querySelector(`[data-province="${defaultProvince}"]`).dataset.providerId); // Carrega os apoiadores da prov√≠ncia padr√£o
                }
            }

            function renderInformalGrid(province, data) {
                const gridContainer = document.getElementById('informal-market-grid');
                const provinceRates = data[province] || [];
                const requiredPairs = ['USD/AOA', 'EUR/AOA', 'USDT/AOA'];

                gridContainer.innerHTML = requiredPairs.map(pair => {
                    const item = provinceRates.find(p => p.pair === pair);
                    const [from, to] = pair.split('/');
                    const fromFlag = currencyFlags[from] || 'üè≥Ô∏è';
                    const toFlag = currencyFlags[to] || 'üè≥Ô∏è';

                    if (item) {
                        const equivalence = formatNumber(100 * item.rate);
                        return `
                            <div class="bg-gray-50 border border-gray-200 p-4 rounded-xl hover:shadow-lg hover:-translate-y-1 transition-all duration-300">
                                <p class="text-sm text-gray-500 font-bold">${fromFlag} ${from} / ${toFlag} ${to}</p>
                                <p class="text-2xl font-bold text-gray-800 mt-1">${formatNumber(item.rate)}</p>
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <p class="text-xs text-gray-500">100 ${from} <span class="font-semibold">‚âà</span> ${equivalence} ${to}</p>
                                </div>
                            </div>`;
                    }
                    return `
                            <div class="bg-gray-50 border border-gray-200 p-4 rounded-xl opacity-60">
                                <p class="text-sm text-gray-500 font-bold">${fromFlag} ${from} / ${toFlag} ${to}</p>
                                <p class="text-2xl font-bold text-gray-400 mt-1">N/A</p>
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <p class="text-xs text-gray-400">Dados indispon√≠veis</p>
                                </div>
                            </div>`;
                }).join('');
            }

            function setupQuickConverter() {
                const amountInput = document.getElementById('quick-converter-amount');
                const switchBtn = document.getElementById('quick-converter-switch');
                const fromSelect = document.getElementById('quick-converter-from');
                const toSelect = document.getElementById('quick-converter-to');
                const resultDisplay = document.getElementById('quick-converter-result');

                appState.addListener((bankData) => {
                    document.getElementById('quick-converter-bank-name').textContent = bankData.code;
                    calculate();
                });

                const calculate = () => {
                    const amountStr = amountInput.value.replace(/\./g, '').replace(',', '.');
                    const amount = parseFloat(amountStr);
                    if (isNaN(amount) || amount === 0) {
                        resultDisplay.textContent = '';
                        return;
                    }

                    const from = fromSelect.value, to = toSelect.value;
                    const rates = appState.selectedBank;
                    let rate = 0;
                    if (from === 'USD' && to === 'AOA') rate = rates.usd_rate;
                    else if (from === 'AOA' && to === 'USD') rate = 1 / rates.usd_rate;
                    else if (from === 'EUR' && to === 'AOA') rate = rates.eur_rate;
                    else if (from === 'AOA' && to === 'EUR') rate = 1 / rates.eur_rate;
                    else if (from === 'USD' && to === 'EUR') rate = rates.usd_rate / rates.eur_rate;
                    else if (from === 'EUR' && to === 'USD') rate = rates.eur_rate / rates.usd_rate;
                    else if (from === to) rate = 1;

                    resultDisplay.textContent = (rate && isFinite(rate)) 
                        ? `‚âà ${formatNumber(amount * rate)} ${to}`
                        : 'Taxa indispon√≠vel';
                };

                [amountInput, fromSelect, toSelect].forEach(el => el.addEventListener('input', calculate));
                switchBtn.addEventListener('click', () => { [fromSelect.value, toSelect.value] = [toSelect.value, fromSelect.value]; calculate(); });
            }

            function init(data) {
                renderBankCards('formal-market-grid', data.formal_rates || []);
                renderInformalMarket(data.informal_rates_by_province || {});
                setupQuickConverter();
            }

            return { init };
        })();

        // --- M√ìDULO DA CALCULADORA ---
        const CalculatorModule = (function() {
            const container = document.getElementById('calculator-card-container');
            let purchasePriceInput, bankSelectorBtn, bankOptionsPanel, selectedBankCode, bankExchangeRateInput, bankFeeMarginInput, bankFeeFinalInput, calculateBtn, calculatorCard, dropdownArrow;
            const themes = { 
                bai: { card: 'theme-bai', color: '#0194b3' }, 
                bfa: { card: 'theme-bfa', color: '#f7931e' }, 
                bic: { card: 'theme-bic', color: '#d42128' },
                bpc: { card: 'theme-bpc', color: '#00529b' },
                bci: { card: 'theme-bci', color: '#1f3a38' },
                yetu: { card: 'theme-yetu', color: '#EAA900' },
                // Fallback para novos bancos: usar o tema do BPC
                default: { card: 'theme-bpc', color: '#00529b' }
            };

            function getThemeCode(bankCode) {
                const code = bankCode.toLowerCase();
                return themes[code] ? code : 'default';
            }

            function render(banks) {
                container.innerHTML = `
                    <div class="p-8">
                        <div class="text-center mb-8"><h2 class="text-3xl font-bold text-white mb-3">Calculadora de C√¢mbio</h2><p class="text-gray-200">Estime o custo da sua compra</p></div>
                        <div class="mb-6">
                            <label for="purchasePrice" class="block text-base font-semibold text-gray-200 mb-3">Valor em D√≥lar</label>
                            <div class="flex items-center rounded-2xl bg-white/90 ring-4 ring-transparent focus-within:ring-green-400 transition">
                                <input type="text" inputmode="decimal" id="purchasePrice" class="flex-1 w-full bg-transparent text-lg p-4 text-gray-900 placeholder-gray-500 focus:outline-none calc-input" placeholder="0,00" />
                                <div class="relative" id="bank-selector-wrapper">
                                    <input type="hidden" id="bankExchangeRate" /><input type="hidden" id="bankFeeMargin" /><input type="hidden" id="bankFeeFinal" />
                                    <button type="button" id="bankSelectorBtn" class="flex items-center justify-between w-32 text-left text-gray-800 text-base p-4 border-l border-gray-400/50">
                                        <span id="selectedBankCode" class="font-bold"></span>
                                        <svg class="w-5 h-5 text-gray-600 transform transition-transform" id="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div id="bankOptionsPanel" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-20 border border-gray-200">${populateBankSelector(banks)}</div>
                                </div>
                            </div>
                        </div>
                        <button id="calculateBtn" class="w-full text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 text-lg transform hover:scale-105 focus:outline-none focus:ring-4">Calcular Custo</button>
                        <div id="result" class="mt-8 border-t border-white/20 pt-6 space-y-4 opacity-0 transition-opacity duration-500">
                            <div><p class="text-base font-semibold text-gray-200">Convers√£o Direta (AOA):</p><p id="directConversionValue" class="text-2xl font-bold text-white mt-1">0,00</p></div>
                            <div class="bg-white/15 backdrop-blur-sm p-5 rounded-2xl border border-white/10"><p class="text-base font-semibold text-white">Valor total a ser descontado (AOA)</p><p id="totalCost" class="text-4xl font-bold text-white mt-1">0,00</p></div>
                        </div>
                    </div>`;
                
                calculatorCard = container;
                purchasePriceInput = document.getElementById('purchasePrice');
                bankSelectorBtn = document.getElementById('bankSelectorBtn');
                bankOptionsPanel = document.getElementById('bankOptionsPanel');
                selectedBankCode = document.getElementById('selectedBankCode');
                dropdownArrow = document.getElementById('dropdown-arrow');
                bankExchangeRateInput = document.getElementById('bankExchangeRate');
                bankFeeMarginInput = document.getElementById('bankFeeMargin');
                bankFeeFinalInput = document.getElementById('bankFeeFinal');
                calculateBtn = document.getElementById('calculateBtn');
            }

            function toggleDropdown() { bankOptionsPanel.classList.toggle('hidden'); dropdownArrow.classList.toggle('rotate-180'); }

            function populateBankSelector(banks) {
                if (!banks || banks.length === 0) return '<div class="px-4 py-3 text-sm text-gray-500">Nenhum banco dispon√≠vel.</div>';
                return banks.sort((a,b) => a.code.localeCompare(b.code)).map(bank => 
                    `<div class="bank-option px-4 py-3 hover:bg-gray-100 cursor-pointer text-gray-800 text-sm" data-code="${bank.code}" data-rate="${bank.usd_rate}" data-fee-margin="${bank.fee_margin}" data-fee-final="${bank.fee_final}"><span class="font-bold">${bank.code}</span></div>`
                ).join('');
            }

            function selectBank(bankData) {
                selectedBankCode.textContent = bankData.code;
                bankExchangeRateInput.value = bankData.rate;
                bankFeeMarginInput.value = bankData.feeMargin;
                bankFeeFinalInput.value = bankData.feeFinal;
                
                const themeCode = getThemeCode(bankData.code);
                const theme = themes[themeCode];
                calculatorCard.className = `w-full max-w-xl mx-auto calculator-card min-h-[400px] ${theme ? theme.card : ''}`;
                document.documentElement.style.setProperty('--theme-color', theme.color);
            }
            
            function handleCalculation() {
                const priceStr = purchasePriceInput.value.replace(/\./g, '').replace(',', '.');
                const [price, rate, margin, finalFee] = [priceStr, bankExchangeRateInput.value, bankFeeMarginInput.value, bankFeeFinalInput.value].map(parseFloat);
                const resultPanel = document.getElementById('result');

                if (![price, rate].every(v => !isNaN(v) && v > 0)) { resultPanel.classList.add('opacity-0'); return; }
                
                const directConversion = price * rate;
                const totalCost = directConversion * (1 + (margin/100 || 0)) * (1 + (finalFee/100 || 0));
                
                document.getElementById('directConversionValue').textContent = `${directConversion.toLocaleString('pt-AO', { style: 'currency', currency: 'AOA' })}`;
                document.getElementById('totalCost').textContent = `${totalCost.toLocaleString('pt-AO', { style: 'currency', currency: 'AOA' })}`;
                resultPanel.classList.remove('opacity-0');
            }

            function formatInput(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value === '') { e.target.value = ''; return; }
                const num = BigInt(value);
                const formatted = new Intl.NumberFormat('pt-PT', { minimumFractionDigits: 2 }).format(Number(num) / 100);
                e.target.value = formatted;
            }

            function init(banks) {
                if (!banks || banks.length === 0) {
                    container.innerHTML = `<div class="p-8 text-center text-white"><h3 class="font-bold text-lg">Calculadora Indispon√≠vel</h3><p>N√£o foi poss√≠vel carregar os dados dos bancos.</p></div>`;
                    return;
                }
                render(banks);
                
                const firstBank = banks.find(b => b.code === 'BAI') || banks[0];
                selectBank({ code: firstBank.code, rate: firstBank.usd_rate, feeMargin: firstBank.fee_margin, feeFinal: firstBank.fee_final });
                
                bankSelectorBtn.addEventListener('click', toggleDropdown);
                calculateBtn.addEventListener('click', handleCalculation);
                purchasePriceInput.addEventListener('input', formatInput);
                
                bankOptionsPanel.addEventListener('click', (e) => {
                    if (e.target.closest('.bank-option')) {
                        selectBank(e.target.closest('.bank-option').dataset);
                        toggleDropdown();
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!document.getElementById('bank-selector-wrapper').contains(e.target)) {
                        bankOptionsPanel.classList.add('hidden'); dropdownArrow.classList.remove('rotate-180');
                    }
                });
            }
            return { init, getThemeCode };
        })();

        // --- M√ìDULO WEBSOCKET ---
        const WebSocketModule = (function() {
            function connect() {
                try {
                    ws = new WebSocket(WEBSOCKET_URL);
                    ws.onopen = () => console.log('WebSocket conectado.');
                    ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        if (message.type === 'rates_updated') {
                            console.log('Recebida notifica√ß√£o de atualiza√ß√£o de taxas. A recarregar dados...');
                            showLiveUpdateToast();
                            reloadMarketData();
                        }
                    };
                    ws.onclose = () => setTimeout(connect, 5000);
                    ws.onerror = (err) => console.error('Erro no WebSocket:', err);
                } catch(e) {
                    console.error("Falha ao conectar ao WebSocket:", e)
                }
            }
            function send(data) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(data));
                }
            }
            return { connect, send };
        })();
        
        function showLiveUpdateToast() {
            const toast = document.createElement('div');
            toast.className = 'fixed top-5 right-5 bg-blue-500 text-white py-3 px-6 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300 ease-out z-50';
            toast.innerHTML = `<p>As taxas foram atualizadas!</p>`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-[120%]'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-[120%]');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- FUN√á√ÉO PRINCIPAL ---
        async function main() {
            setupEventListeners();
            SESSION_ID = getOrCreateSessionId();
            switchTab('market');
            switchMarketTab('formal');
            
            WebSocketModule.connect();

            await reloadMarketData(); // Garante que marketData est√° dispon√≠vel
            loadAffiliateLinks();
            loadSupporters();
            loadFooterInfo();

            logActivity('page_view');
        }

        async function reloadMarketData() {
            try {
                const { data, error } = await dbClient.rpc('get_market_data');
                if (error) throw error;
                marketData = data; 
                if (!marketData || (!marketData.formal_rates && !marketData.informal_rates_by_province)) {
                   throw new Error("A fun√ß√£o RPC 'get_market_data' n√£o retornou dados v√°lidos.");
                }
            } catch (rpcError) {
                console.warn("RPC 'get_market_data' falhou. Tentando fallback.", rpcError.message);
                marketData = await fallbackFetchMarketData();
            }

            if (!marketData) {
                console.error("N√£o foi poss√≠vel obter os dados do mercado.");
                document.getElementById('myTabContent').innerHTML = `<div class="text-center p-8 bg-red-50 text-red-700 rounded-2xl"><h3 class="font-bold text-lg">Erro ao Carregar Dados</h3><p>N√£o foi poss√≠vel comunicar com a base de dados. Tente mais tarde.</p></div>`;
                return;
            }

            document.querySelectorAll('.loader-container').forEach(el => el.style.display = 'none');
            MarketModule.init(marketData);
            const banksForCalculator = marketData.formal_rates?.filter(bank => bank.code !== 'BNA') || [];
            CalculatorModule.init(banksForCalculator);
        }

        async function fallbackFetchMarketData() {
            try {
                const { data: providers, error } = await dbClient.from('rate_providers').select('*, exchange_rates(*)').eq('is_active', true);
                if (error) throw error;

                return {
                    formal_rates: providers.filter(p => p.type === 'FORMAL').map(p => ({
                        code: p.code, name: p.name,
                        usd_rate: p.exchange_rates.find(r => r.currency_pair === 'USD/AOA')?.sell_rate || null,
                        eur_rate: p.exchange_rates.find(r => r.currency_pair === 'EUR/AOA')?.sell_rate || null,
                        fee_margin: p.fee_margin, fee_final: p.fee_final
                    })),
                    informal_rates_by_province: providers.filter(p => p.type === 'INFORMAL' && p.exchange_rates.length > 0)
                        .reduce((acc, p) => {
                            acc[p.name] = p.exchange_rates.map(rate => ({ pair: rate.currency_pair, rate: rate.sell_rate, provider_id: p.id }));
                            return acc;
                        }, {})
                };
            } catch (fallbackError) {
                console.error("Falha no fallback:", fallbackError);
                return null;
            }
        }

        async function loadAffiliateLinks() {
            const track = document.getElementById('affiliate-track');
            const container = document.getElementById('affiliate-links-container'); // Container com scroll
                const { data, error } = await dbClient // A query √© feita aqui
                    .from('affiliate_links')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false })
                    .limit(12);

            const wrapper = document.getElementById('affiliate-links-wrapper');

            if (error || !data || data.length === 0) {
                if (error) console.error('Erro ao carregar links de afiliados:', error);
                wrapper.closest('.bg-slate-800').classList.add('hidden');
                return;
            }

            const bnaRate = marketData?.formal_rates?.find(r => r.code === 'BNA')?.usd_rate;

            const linksHTML = data.map(link => `
                <a href="details.html?id=${link.id}" class="affiliate-link-item group block bg-slate-700 rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-shadow duration-300 w-48 md:w-56 flex-shrink-0">
                        <img src="${link.image_url || '/assets/error-state.svg'}" alt="Imagem de ${link.title}" class="w-full h-32 object-cover group-hover:opacity-80 transition-opacity bg-slate-600" loading="lazy" decoding="async" onerror="this.onerror=null; this.src='/assets/error-state.svg'; this.classList.add('p-4');">
                        <div class="p-3">
                            <h3 class="text-sm font-semibold text-white truncate">${link.title}</h3>
                            <p class="text-base font-bold text-emerald-400 mt-1">
                                ${bnaRate ? formatCurrency(((link.price || 0) + (link.shipping_cost_usd || 0)) * bnaRate, 'AOA') : 'Ver detalhes'}
                            </p>
                        </div>
                    </a>`).join('');

            // Verifica se h√° dados v√°lidos antes de renderizar
            if (!linksHTML || linksHTML.trim() === '') {
                wrapper.closest('.bg-slate-800').classList.add('hidden');
                return;
            }

            // Duplica o conte√∫do para o efeito de loop infinito
            track.innerHTML = linksHTML + linksHTML;

            // Adiciona event listeners para os links de afiliados
            track.querySelectorAll('.affiliate-link-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    logActivity('affiliate_click', { link_id: link.href.split('id=')[1], product_title: link.querySelector('h3').textContent });
                });
            });

            // Inicia o auto-scroll
            startAffiliateAutoScroll();

            // L√≥gica dos bot√µes de navega√ß√£o do carrossel
            const prevBtn = document.getElementById('affiliate-prev-btn');
            const nextBtn = document.getElementById('affiliate-next-btn');

            nextBtn.addEventListener('click', () => {
                pauseAffiliateAutoScroll();
                container.scrollBy({ left: container.offsetWidth / 2, behavior: 'smooth' });
            });

            prevBtn.addEventListener('click', () => {
                pauseAffiliateAutoScroll();
                container.scrollBy({ left: -container.offsetWidth / 2, behavior: 'smooth' });
            });

            // Pausa o scroll quando o mouse est√° sobre o container
            wrapper.addEventListener('mouseenter', () => clearInterval(affiliateAutoScrollInterval));

            // Reinicia o scroll quando o mouse sai
            wrapper.addEventListener('mouseleave', startAffiliateAutoScroll);
        }

        function startAffiliateAutoScroll() {
            // Limpa qualquer intervalo existente para evitar acelera√ß√£o
            if (affiliateAutoScrollInterval) clearInterval(affiliateAutoScrollInterval);

            const container = document.getElementById('affiliate-links-container');
            const track = document.getElementById('affiliate-track');
            
            // Ponto m√©dio onde o scroll deve ser reiniciado
            const scrollWidth = track.scrollWidth / 2;

            affiliateAutoScrollInterval = setInterval(() => {
                // Se o scroll passou do ponto m√©dio, reinicia silenciosamente
                if (container.scrollLeft >= scrollWidth) {
                    container.scrollLeft = 0;
                }
                // Move o scroll um pouco para a direita
                container.scrollLeft += 1;
            }, 25); // Ajuste este valor para mudar a velocidade (menor = mais r√°pido)
        }

        function pauseAffiliateAutoScroll() {
            // Limpa o intervalo de auto-scroll
            clearInterval(affiliateAutoScrollInterval);
            
            // Define um temporizador para reiniciar o auto-scroll ap√≥s um per√≠odo de inatividade
            let timeoutId;
            clearTimeout(timeoutId); // Limpa qualquer temporizador anterior
            timeoutId = setTimeout(() => {
                startAffiliateAutoScroll();
            }, 5000); // Reinicia ap√≥s 5 segundos
        }
        
        async function loadSupporters(providerId = null) {
            const carouselContainer = document.getElementById('supporters-carousel-container'); // Renamed for clarity
            const section = document.getElementById('supporters-section');
            const indicators = document.getElementById('supporter-indicators');

            // Carrega todos os apoiadores globais ativos e suas URLs de banner
            const [supportersResult, settingsResult] = await Promise.all([ // eslint-disable-line no-unused-vars
                dbClient.from('supporters').select('*').eq('is_active', true).order('name'),
                dbClient.from('site_settings').select('*').like('key', 'supporter_%_banner_url')
            ]);

            if (supportersResult.error || !supportersResult.data || supportersResult.data.length === 0) {
                if (supportersResult.error) console.error('Erro ao carregar apoiadores:', supportersResult.error);
                section.classList.add('hidden'); // Hide the entire section if no supporters
                return;
            }

            const bannerUrls = (settingsResult.data || []).reduce((acc, setting) => {
                const supporterId = setting.key.match(/supporter_(\d+)_banner_url/)?.[1];
                if (supporterId) {
                    acc[supporterId] = setting.value;
                }
                return acc;
            }, {});

            const data = supportersResult.data.map(supporter => ({
                ...supporter,
                banner_url: bannerUrls[supporter.id]
            }));

            section.classList.remove('hidden'); // Show the section if there are supporters
            
            // Carousel state
            let currentSlide = 0;
            let slideInterval;

            const slidesWrapper = document.getElementById('supporter-slides-wrapper');

            const bannersHTML = data.map((supporter, index) => `
                <div class="supporter-slide flex-shrink-0 w-full h-full" data-slide="${index}">
                    <a href="${supporter.website_url}" target="_blank" rel="noopener sponsored"
                       class="supporter-link block w-full h-full"
                       data-supporter-id="${supporter.id}" data-supporter-name="${supporter.name}">
                        <div class="relative w-full h-full bg-white flex items-center justify-center overflow-hidden rounded-2xl shadow-xl">
                            <img src="${supporter.banner_url || supporter.logo_url || '/assets/error-state.svg'}"
                                 alt="${supporter.name}"
                                 class="w-full h-full object-cover transform transition-transform duration-700 hover:scale-105"
                                 loading="lazy" decoding="async"
                                 style="image-rendering: -webkit-optimize-contrast;"
                                 onerror="this.onerror=null; this.src='/assets/error-state.svg'; this.classList.add('p-8');">
                        </div>
                    </a>
                </div>
            `).join('');
            slidesWrapper.innerHTML = bannersHTML;

            const slides = slidesWrapper.querySelectorAll('.supporter-slide');
            const prevBtn = document.getElementById('supporter-prev');
            const nextBtn = document.getElementById('supporter-next');

            function updateDots() {
                const dots = indicators.querySelectorAll('button');
                dots.forEach((dot, i) => {
                    dot.classList.toggle('bg-emerald-500', i === currentSlide);
                    dot.classList.toggle('w-6', i === currentSlide);
                    dot.classList.toggle('bg-slate-300/50', i !== currentSlide);
                    dot.classList.toggle('w-2', i !== currentSlide);
                });
            }

            function showSlide(index) {
                if (index >= slides.length) index = 0;
                if (index < 0) index = slides.length - 1;
                
                currentSlide = index;
                slidesWrapper.style.transform = `translateX(${-currentSlide * 100}%)`;
                updateDots();
            }

            // Cria indicadores
            indicators.innerHTML = data.map((_, index) => `
                <button class="h-2 rounded-full transition-all duration-300 ease-in-out transform hover:scale-110"
                        data-indicator="${index}" 
                        aria-label="Go to slide ${index + 1}"></button>
            `).join('');

            // Configura√ß√£o do slideshow autom√°tico
            function startSlideshow() {
                if (slideInterval) clearInterval(slideInterval);
                if (data.length > 1) {
                    slideInterval = setInterval(() => {
                        showSlide(currentSlide + 1);
                    }, 6000);
                }
            }

            function stopSlideshow() {
                clearInterval(slideInterval);
            }

            // Event listeners for navigation buttons
            prevBtn.addEventListener('click', () => {
                stopSlideshow();
                showSlide(currentSlide - 1);
                startSlideshow();
            });
            nextBtn.addEventListener('click', () => {
                stopSlideshow();
                showSlide(currentSlide + 1);
                startSlideshow();
            });

            // Event listener para indicadores
            indicators.querySelectorAll('button').forEach(dot => {
                dot.addEventListener('click', () => {
                    const slideIndex = parseInt(dot.dataset.indicator, 10);
                    if (slideIndex !== currentSlide) {
                        stopSlideshow();
                        showSlide(slideIndex);
                        startSlideshow();
                    }
                });
            });

            // Pausa no hover
            carouselContainer.addEventListener('mouseenter', stopSlideshow);
            carouselContainer.addEventListener('mouseleave', startSlideshow);

            // Adiciona event listeners para os links
            slidesWrapper.querySelectorAll('.supporter-link').forEach(link => {
                link.addEventListener('click', () => {
                    logActivity('supporter_click', {
                        supporter_id: link.dataset.supporterId,
                        supporter_name: link.dataset.supporterName
                    });
                });
            });
            
            // Initial setup
            showSlide(0);
            if (data.length > 1) {
                prevBtn.disabled = false;
                nextBtn.disabled = false;
                startSlideshow();
            } else {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                indicators.classList.add('hidden');
            }
        }

        async function loadFooterInfo() {
            const container = document.getElementById('footer-contact-info');
            const socialContainer = document.getElementById('social-media-links');
            if (!container || !socialContainer) return;

            try {
                const { data: contactData, error: contactError } = await dbClient
                    .from('site_settings')
                    .select('key, value')
                    .in('key', ['contact_email', 'contact_phone']);
                if (contactError) throw contactError;

                const { data: socialData, error: socialError } = await dbClient
                    .from('site_settings')
                    .select('key, value')
                    .in('key', ['facebook_url', 'instagram_url', 'linkedin_url', 'whatsapp_url']);
                if (socialError) throw socialError;

                const settings = contactData.reduce((acc, { key, value }) => { acc[key] = value; return acc; }, {});

                let html = '';
                if (settings.contact_email) {
                    html += `<a href="mailto:${settings.contact_email}" class="inline-block mx-2 hover:text-white transition-colors">${settings.contact_email}</a>`;
                }
                if (settings.contact_phone) {
                    html += `<a href="tel:${settings.contact_phone}" class="inline-block mx-2 hover:text-white transition-colors">${settings.contact_phone}</a>`;
                }
                container.innerHTML = html;
            } catch (error) {
                console.error("Erro ao carregar informa√ß√µes de contato do rodap√©:", error);
            }
        }

        async function logActivity(type, details = {}) {
            try {
                if (!type) return;
                // Monta o objeto com a estrutura correta que a tabela 'user_activity' espera
                const activityData = { event_type: type, details, session_id: SESSION_ID };
                
                // Envia os dados para o servidor via WebSocket, que por sua vez os insere na BD
                // e notifica o painel de administra√ß√£o.
                WebSocketModule.send({ type: 'log_activity', payload: activityData });
            } catch (error) {
                console.error('Erro cr√≠tico ao registrar atividade:', error);
            }
        }

        async function initializeApp() {
            const style = document.createElement('style');

            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Falha ao carregar a configura√ß√£o do servidor.');
                const config = await response.json();
                
                dbClient = supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                main();
            } catch (error) {
                console.error("Erro de inicializa√ß√£o:", error);
                document.body.innerHTML = `<div class="p-8 m-8 text-center bg-red-100 text-red-800 rounded-lg"><strong>Erro Cr√≠tico:</strong> N√£o foi poss√≠vel carregar a configura√ß√£o da aplica√ß√£o.</div>`;
                return;
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

  </body>
</html>