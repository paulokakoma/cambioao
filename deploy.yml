# .github/workflows/deploy.yml

name: Deploy to Contabo

# Dispara o workflow em cada push para a branch 'main'
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üìÇ Sync files to server
        # Copia os ficheiros do reposit√≥rio para o servidor, excluindo node_modules e .git
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.CONTABO_HOST }}
          username: ${{ secrets.CONTABO_USER }}
          key: ${{ secrets.CONTABO_SSH_KEY }}
          source: "."
          target: "/home/${{ secrets.CONTABO_USER }}/cambioao" # Ajuste se o caminho for diferente
          strip_components: 1 # Remove o primeiro n√≠vel de diret√≥rio da origem
          rm: true # Remove ficheiros no destino que n√£o existem na origem

      - name: üöÄ Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CONTABO_HOST }}
          username: ${{ secrets.CONTABO_USER }}
          key: ${{ secrets.CONTABO_SSH_KEY }}
          script: |
            # Navega para a pasta do projeto
            cd /home/${{ secrets.CONTABO_USER }}/cambioao

            # Garante que o ficheiro .env existe (ele n√£o √© copiado pelo scp)
            # Se n√£o existir, cria um ficheiro vazio para evitar erros.
            # IMPORTANTE: Voc√™ deve criar e preencher este ficheiro no servidor na primeira vez.
            if [ ! -f .env ]; then
              echo "AVISO: Ficheiro .env n√£o encontrado. Criando um vazio."
              touch .env
            fi

            # Faz o build da nova imagem e reinicia o servi√ßo com docker-compose
            # O --build for√ßa a reconstru√ß√£o da imagem com o novo c√≥digo
            # O -d (detached) executa em segundo plano
            sudo docker-compose -f docker-compose.prod.yml up --build -d

            # Limpa imagens Docker antigas e n√£o utilizadas para poupar espa√ßo
            sudo docker image prune -af

